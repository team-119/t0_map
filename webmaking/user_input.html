<!DOCTYPE html>
<html>
    <head>
        <title>EMERSERVICE input</title>
        <title>t0 + mapservice</title>
        <script	src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
        <script src="https://apis.openapi.sk.com/tmap/jsv2?version=2&appKey=l7xxf6a3bebd3c3b4d69bdbd799bc288845d"></script>
        <script type="text/javascript">

            var map;
            var marker_s;
            var marker_e = [];
            var my = {lat: 37.9504963, lon: 127.02928809999999}; //내좌표
            var s = {name: "[권역][외상]가톨릭대학교의정부성모병원", lat: 37.758568, lon: 127.077705, ETE: "", ETA: ""};
            var u = {name: "[기관]경기도의료원의정부병원", lat: 37.741181, lon: 127.042525, ETE: "", ETA: ""};
            var b = {name: "[기관]의료법인영동의료재단의정부백병원", lat: 37.745791, lon: 127.061916, ETE: "", ETA: ""};
            var c = {name: "[기관]추병원", lat: 37.750760, lon: 127.046260, ETE: "", ETA: ""};
            const hospital = [s, u, b, c];

            function setMap()   // 지도 생성
            {
                map = new Tmapv2.Map("map_div", {
                    center : new Tmapv2.LatLng(my.lat, my.lon),
                    width : "50%",
                    height : "400px",
                    zoom : 15,
                    zoomControl : true,
                    scrollwheel : true
                });

            }   // setMap [E]

            function setMarker()    // 마커 생성
            {
                // 현위치마커
                marker_s = new Tmapv2.Marker({
                            position : new Tmapv2.LatLng(my.lat, my.lon),
                            icon : "http://tmapapis.sktelecom.com/upload/tmap/marker/pin_r_m_s.png",
                            iconSize : new Tmapv2.Size(24, 38),
                            map : map
                });

                // 병원마커
                for (var i = 0; i < 4; i++)
                {
                    //Marker 객체 생성.
                    var marker = new Tmapv2.Marker({
                                    title : hospital[i].name,
                                    position : new Tmapv2.LatLng(hospital[i].lat, hospital[i].lon),
                                    icon : "http://tmapapis.sktelecom.com/upload/tmap/marker/pin_r_m_e.png",
                                    iconSize : new Tmapv2.Size(24, 38),
                                    map : map
                                });
                    marker.setMap(map); //Marker가 표시될 Map 설정.
                    marker_e.push(marker);
                }
                
            } // setMarker [E]

            function getLocation()  // 좌표 로딩, 지도중심변경, 현위치마커
            {  
                if(navigator.geolocation)
                {
                    navigator.geolocation.getCurrentPosition(function(position)
                    {
                        my.lat = position.coords.latitude;
                        my.lon = position.coords.longitude;

                        document.getElementById("location").innerHTML = // 위도경도 출력
                        "Latitude: " + my.lat + "<br>" +
                        "Longitude: " + my.lon;
                        
                        // 지도중심 변경
                        map.setCenter(new Tmapv2.LatLng(my.lat, my.lon));

                        // 현위치마커 변경
                        marker_s.setPosition(new Tmapv2.LatLng(my.lat, my.lon));

                    }); // getCurrentPosition [E]

                } // if(navigator.geolocation) [E]

            }   // getLocation [E]

            function Main() {   // 메인함수

                setMap();       // 1. 지도 띄우기
                setMarker();    // 2. 마커 생성
                getLocation();  // 3. 좌표 로딩, 지도중심변경, 현위치마커

                // 4. Tmap api 경로계산, 결과출력
                    $("#btn_select")
                        .click(
                            function() {

                                getLocation();  // 좌표 업데이트
                                var now = new Date(); // 현재시간 정보로딩              
                                var nowHour = now.getHours(); //현재시
                                var nowMinute = now.getMinutes(); //현재분
                                var TIME = " 현재시간 : " + nowHour + ":" + nowMinute;

                                for(var selectHospital=0; selectHospital<4; selectHospital++)
                                {
                                
                                //JSON TYPE EDIT [S]
                                $
                                    .ajax({
                                        type : "POST",
                                        url : "https://apis.openapi.sk.com/tmap/routes?version=2&format=json&callback=result",
                                        async : false,
                                        data : {
                                            "appKey" : "l7xxf6a3bebd3c3b4d69bdbd799bc288845d",
                                            //경로요청 시작점좌표
                                            "startX" : my.lon,
                                            "startY" : my.lat,
                                            //경로요청 끝점좌표
                                            "endX" : hospital[selectHospital].lon,
                                            "endY" : hospital[selectHospital].lat,
                                            "reqCoordType" : "WGS84GEO", //좌표요청타입
                                            "resCoordType" : "EPSG3857", //좌표반환타입
                                            "searchOption" : 2, // (교통최적+최단시간)옵션으로 경로요청 선택
                                        },
                                        success : function(response) {
                                            
                                            var resultData = response.features; // 경로요청 결과로딩
                                            var totalTime = Number((resultData[0].properties.totalTime / 60).toFixed(0)); // 소요시간(분)

                                            var finalHour = Math.floor(((nowHour + (nowMinute + totalTime)/60)%24)); //도착시
                                            var finalMinute = (nowMinute+totalTime)%60; //도착분

                                            hospital[selectHospital].ETE = totalTime;
                                            hospital[selectHospital].ETA = finalHour + ":" + finalMinute;
                                            
                                        },
                                        error : function(request, status, error) {
                                            console.log("code:"
                                                    + request.status + "\n"
                                                    + "message:"
                                                    + request.responseText
                                                    + "\n" + "error:" + error);
                                        }
                                    }); // .ajax [E]  JSON TYPE EDIT [E]   
                                    
                                }   // for [E]

                            $("#TIME").text(TIME)
                            $("#result0").text(hospital[0].ETE + "//" + hospital[0].ETA)
                            $("#result1").text(hospital[1].ETE + "//" + hospital[1].ETA)               
                            $("#result2").text(hospital[2].ETE + "//" + hospital[2].ETA)
                            $("#result3").text(hospital[3].ETE + "//" + hospital[3].ETA)                
                            // 결과출력

                            }); // .click [E]

            }   // Main [E]
                
        </script>
    </head>

    <body onload="Main()">

        <h1>EMERSERVICE</h1>
        <h2>응급환자정보입력</h2>

        <form action = "/{{patient.id}}/user_ouput" method="POST"></form>

            <div> <!--전체 체크리스트 [S]-->
                <!-- 응급도정보 [S]-->																		
                <div class="emer-table">
                    <h2 style="padding: 7px; font-size: 15px;">
                        <span style="font-size: 11px;font-weight: 500" class="bull">●</span>&nbsp;응급도
                            
                            
                        
                        &nbsp;&nbsp;
                        <input type="checkbox" class="allchk_emer" id="emer_all">
                        <label for="emer_all" style="font-size: 13px">전체선택</label>
                    </h2>
                    <table>
                        <colgroup>
                            
                                <col width="25.0%">
                            
                                <col width="25.0%">
                            
                                <col width="25.0%">
                            
                                <col width="25.0%">
                            
                        </colgroup>
    
                            <tbody>
                                
                                <tr>

                                    <td>
                                        <input type="checkbox" id="label_emer0" name="emer" class="width_90 svdss_cd" value="emer0"> <!--선택X-->
                                        <label for="label_emer0">선택안함</label>
                                    </td>


                                    <td>
                                        <input type="checkbox" id="label_emer1" name="emer" class="width_90 svdss_cd" value="emer1">
                                        <label for="label_emer1">긴급</label>
                                    </td>
                                                                
                                                                                                                    
                                    <td>
                                        <input type="checkbox" id="label_emer2" name="emer" class="width_90 svdss_cd" value="emer2">
                                        <label for="label_emer2">응급</label>
                                    </td>
                                    
                                    
                                    <td>
                                        <input type="checkbox" id="label_emer3" name="emer" class="width_90 svdss_cd" value="emer3">
                                        <label for="label_emer3">비응급</label>
                                    </td>
                                
                                                                            
                                    <td>&nbsp;</td>
                                                                                                                                    
                            
                        
                        
                                </tr></tbody>
                    </table>
                                    

                </div>
                <!--  응급도정보 [E]-->
                

                <!-- 필요한병상정보 [S]-->																		
                <div class="bed-table">
                    <h2 style="padding: 7px; font-size: 15px;">
                        <span style="font-size: 11px;font-weight: 500" class="bull">●</span>&nbsp;실시간병상정보
                            
                            
                        
                        &nbsp;&nbsp;
                        <input type="checkbox" class="allchk_bed" id="bed_all">
                        <label for="bed_all" style="font-size: 13px">전체선택</label>
                    </h2>
                    <table>
                        <colgroup>
                            
                                <col width="25.0%">
                            
                                <col width="25.0%">
                            
                                <col width="25.0%">
                            
                                <col width="25.0%">
                            
                        </colgroup>
    
                        <tbody>
                            
                            <tr class="diffColor">                                                                  
                                <td>
                                    <input type="checkbox" id="label_bed0" name="bed" class="width_90 svdss_cd" value="bed0">
                                    <label for="label_bed0">선택안함</label>
                                </td>
                                                            
                                                                                                                
                                <td>
                                    <input type="checkbox" id="label_bed1" name="bed" class="width_90 svdss_cd" value="bed1">
                                    <label for="label_bed1">[응급실] 일반</label>
                                </td>                                    
                                                                                                       
                                <td>&nbsp;</td>
                                                                                                                                                                
                            </tr></tbody>
                    </table>
                                
                </div>
                <!--  필요한병상정보 [E]-->


                <!-- 중증응급질환정보 [S]-->
                <div class="disease-table">
                    <h2 style="padding: 7px; font-size: 15px;"> 
                        <span style="font-size: 11px;font-weight: 500" class="bull">●</span>&nbsp;중증응급질환정보
                        <span style="font-size: 11px; font-weight: 500; margin:5px 0 0 0;">
                            
                            
                        </span>
                        &nbsp;&nbsp;
                        <input type="checkbox" class="allchk_dis" id="dis_all">
                        <label for="dis_all" style="font-size: 13px">전체선택</label>
                    </h2>
                    <table>
                        <colgroup>
                            
                                <col width="25.0%">
                            
                                <col width="25.0%">
                            
                                <col width="25.0%">
                            
                                <col width="25.0%">
                            
                        </colgroup>

                        <tbody>
                            
                                <tr>
                                    <td>
                                        <input type="checkbox" id="label_dis1" name="disease" class="width_90 svdss_cd" value="dis1">
                                        <label for="label_dis1">[재관류중재술] 심근경색</label>
                                    </td>
                                                                
                                                                                                                    
                                    <td>
                                        <input type="checkbox" id="label_dis2" name="disease" class="width_90 svdss_cd" value="dis2">
                                        <label for="label_dis2">[재관류중재술] 뇌경색</label>
                                    </td>
                                    
                                                                                                                    
                                
                                    <td>
                                        <input type="checkbox" id="label_dis3" name="disease" class="width_90 svdss_cd" value="dis3">
                                        <label for="label_dis3">[뇌출혈수술] 거미막하출혈</label>
                                    </td>
                                                                
                                                            
                                
                                    <td>
                                        <input type="checkbox" id="label_dis4" name="disease" class="width_90 svdss_cd" value="dis4">
                                        <label for="label_dis4">[뇌출혈수술] 거미막하출혈외</label>
                                    </td>
                                    
                                </tr>
                            
                                
                            
                                <tr class="diffColor">
                                    <td>
                                        <input type="checkbox" id="label_dis5" name="disease" class="width_90 svdss_cd" value="dis5">
                                        <label for="label_dis5">[대동맥응급] 흉부</label>
                                    </td>
                                    
                                
                                                                                                                
                                    <td>
                                        <input type="checkbox" id="label_dis6" name="disease" class="width_90 svdss_cd" value="dis6">
                                        <label for="label_dis6">[대동맥응급] 복부</label>
                                    </td>
                                                                                                                                
                            
                                
                                    <td>
                                        <input type="checkbox" id="label_dis7" name="disease" class="width_90 svdss_cd" value="dis7">
                                        <label for="label_dis7">[담낭담관질환] 담낭질환</label>
                                    </td>
                                    
                                
                                                                                                                    
                                    <td>
                                        <input type="checkbox" id="label_dis8" name="disease" class="width_90 svdss_cd" value="dis8">
                                        <label for="label_dis8">[담낭담관질환] 담도포함질환</label>
                                    </td>
                                    
                                </tr>
                            
                                
                            
                                <tr>
                                    <td>
                                        <input type="checkbox" id="label_dis9" name="disease" class="width_90 svdss_cd" value="dis9">
                                        <label for="label_dis9">[복부응급수술] 비외상</label>
                                    </td>
                                    
                                
                                                                                                                        
                                    <td>
                                        <input type="checkbox" id="label_dis10" name="disease" class="width_90 svdss_cd" value="dis10">
                                        <label for="label_dis10">[장중첩/폐색] 영유아</label>
                                    </td>
                                                                                                                                
                            
                                
                                    <td>
                                        <input type="checkbox" id="label_dis11" name="disease" class="width_90 svdss_cd" value="dis11">
                                        <label for="label_dis11">[사지접합의수술] 수족지접합</label>
                                    </td>
                                    
                                
                                                                                                                        
                                    <td>
                                        <input type="checkbox" id="label_dis12" name="disease" class="width_90 svdss_cd" value="dis12">
                                        <label for="label_dis12">[사지접합의수술] 수족지접합외</label>
                                    </td>
                                    
                                </tr>
                            
                                
                            
                                <tr class="diffColor">
                                    <td>
                                        <input type="checkbox" id="label_dis13" name="disease" class="width_90 svdss_cd" value="dis13">
                                        <label for="label_dis13">[위장관응급내시경] 성인</label>
                                    </td>
                                    
                                
                                                                                                                        
                                    <td>
                                        <input type="checkbox" id="label_dis14" name="disease" class="width_90 svdss_cd" value="dis14">
                                        <label for="label_dis14">[위장관응급내시경] 영유아</label>
                                    </td>
                                    
                                
                                                                                                                        
                                    <td>
                                        <input type="checkbox" id="label_dis15" name="disease" class="width_90 svdss_cd" value="dis15">
                                        <label for="label_dis15">[기관지응급내시경] 성인</label>
                                    </td>
                                    
                                
                                                                                                                    
                                    <td>
                                        <input type="checkbox" id="label_dis16" name="disease" class="width_90 svdss_cd" value="dis16">
                                        <label for="label_dis16">[기관지응급내시경] 영유아</label>
                                    </td>
                                    
                                </tr>
                            
                                
                            
                                <tr>
                                    <td>
                                        <input type="checkbox" id="label_dis17" name="disease" class="width_90 svdss_cd" value="dis17">
                                        <label for="label_dis17">[산부인과응급] 분만</label>
                                    </td>
                                    
                                
                                                                                        
                                
                                    <td>
                                        <input type="checkbox" id="label_dis18" name="disease" class="width_90 svdss_cd" value="dis18">
                                        <label for="label_dis18">[산부인과응급] 산과수술</label>
                                    </td>
                                                                                                                                
                            
                                
                                    <td>
                                        <input type="checkbox" id="label_dis19" name="disease" class="width_90 svdss_cd" value="dis19">
                                        <label for="label_dis19">[산부인과응급] 부인과수술</label>
                                    </td>
                                    
                                
                                                                                        
                                
                                    <td>
                                        <input type="checkbox" id="label_dis20" name="disease" class="width_90 svdss_cd" value="dis20">
                                        <label for="label_dis20">[안과적응급수술]</label>
                                    </td>
                                    
                                </tr>
                            
                                
                            
                                <tr class="diffColor">
                                    <td>
                                        <input type="checkbox" id="label_dis21" name="disease" class="width_90 svdss_cd" value="dis21">
                                        <label for="label_dis21">[응급투석] HD</label>
                                    </td>
                                    
                                
                            
                                                                                            
                                    <td>
                                        <input type="checkbox" id="label_dis22" name="disease" class="width_90 svdss_cd" value="dis22">
                                        <label for="label_dis22">[응급투석] CRRT</label>
                                    </td>
                                    
                                
                            
                                                                                            
                                    <td>
                                        <input type="checkbox" id="label_dis23" name="disease" class="width_90 svdss_cd" value="dis23">
                                        <label for="label_dis23">[영상의학혈관중재] 성인</label>
                                    </td>
                                    
                                
                            
                                                                                            
                                    <td>
                                        <input type="checkbox" id="label_dis24" name="disease" class="width_90 svdss_cd" value="dis24">
                                        <label for="label_dis24">[영상의학혈관중재] 영유아</label>
                                    </td>
                                    
                                </tr>
                            
                                
                            
                                <tr>
                                    <td>
                                        <input type="checkbox" id="label_dis25" name="disease" class="width_90 svdss_cd" value="dis25">
                                        <label for="label_dis25">[정신과적 응급] 폐쇄병동입원</label>
                                    </td>
                                    
                                
                                                                                        
                                
                                    <td>
                                        <input type="checkbox" id="label_dis26" name="disease" class="width_90 svdss_cd" value="dis26">
                                        <label for="label_dis26">[중증화상]</label>
                                    </td>
                                    
                                
                            
                                                                                            
                                    <td>
                                        <input type="checkbox" id="label_dis27" name="disease" class="width_90 svdss_cd" value="dis27">
                                        <label for="label_dis27">[저출생체중아]</label>
                                    </td>
                                    
                                        
                                            <td>&nbsp;</td>
                                                                                                                                        
                                               
                        </tr></tbody>
                    </table>
                </div>
                <!-- 중증응급질환정보 [E]-->
            </div> <!--전체 체크리스트 [E]-->

            <p><input type="submit" value="Submit"> <input type="reset" value="Reset"></p>

        </form>


        <div class="ft_area">            
            <button id="btn_select">결과출력</button>
                <p id="TIME"></p>
                <p id="result0"></p>
                <p id="result1"></p>
                <p id="result2"></p>
                <p id="result3"></p>
        </div>    

        <div id="map_div"></div>

        <p>현위치</p>
        <p id="location"></p>

    </body>

</html>